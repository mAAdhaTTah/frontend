<div id="__next"><div class="flex flex-row"><div class="print:hidden h-screen w-0 xl:w-88" style="width: 352px;"><header class="flex flex-col print:hidden fixed h-screen overflow-hidden w-inherit"><div class="h-screen overflow-hidden relative"><span style="box-sizing:border-box;display:block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:absolute;top:0;left:0;bottom:0;right:0"><img alt="background image" sizes="100vw" srcset="/_next/image/?url=https%3A%2F%2Fstatic.jamesdigioia.com%2Fuploads%2F2020%2F11%2Fheader-1.jpg&amp;w=640&amp;q=75 640w, /_next/image/?url=https%3A%2F%2Fstatic.jamesdigioia.com%2Fuploads%2F2020%2F11%2Fheader-1.jpg&amp;w=750&amp;q=75 750w, /_next/image/?url=https%3A%2F%2Fstatic.jamesdigioia.com%2Fuploads%2F2020%2F11%2Fheader-1.jpg&amp;w=828&amp;q=75 828w, /_next/image/?url=https%3A%2F%2Fstatic.jamesdigioia.com%2Fuploads%2F2020%2F11%2Fheader-1.jpg&amp;w=1080&amp;q=75 1080w, /_next/image/?url=https%3A%2F%2Fstatic.jamesdigioia.com%2Fuploads%2F2020%2F11%2Fheader-1.jpg&amp;w=1200&amp;q=75 1200w, /_next/image/?url=https%3A%2F%2Fstatic.jamesdigioia.com%2Fuploads%2F2020%2F11%2Fheader-1.jpg&amp;w=1920&amp;q=75 1920w, /_next/image/?url=https%3A%2F%2Fstatic.jamesdigioia.com%2Fuploads%2F2020%2F11%2Fheader-1.jpg&amp;w=2048&amp;q=75 2048w, /_next/image/?url=https%3A%2F%2Fstatic.jamesdigioia.com%2Fuploads%2F2020%2F11%2Fheader-1.jpg&amp;w=3840&amp;q=75 3840w" src="/_next/image/?url=https%3A%2F%2Fstatic.jamesdigioia.com%2Fuploads%2F2020%2F11%2Fheader-1.jpg&amp;w=3840&amp;q=75" decoding="async" data-nimg="fill" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%;object-fit:cover;object-position:center center"></span></div><div class="absolute bg-etched rounded-lg text-center inline-flex lg:flex flex-row items-center justify-center lg:justify-start w-full max-w-xs sm:max-w-sm lg:max-w-md pin-center -mt-8 m-auto w-full"><div class="flex flex-row items-center justify-center w-full p-2"><div class="w-0 lg:w-48 h-48 rounded-full overflow-hidden grow-0 transition-width ease-in-out lg:w-0"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27360%27%20height=%27360%27/%3e"></span><img alt="avatar" srcset="/_next/image/?url=https%3A%2F%2Fstatic.jamesdigioia.com%2Fuploads%2F2015%2F02%2Fnew-avatar-sq.jpg&amp;w=384&amp;q=75 1x, /_next/image/?url=https%3A%2F%2Fstatic.jamesdigioia.com%2Fuploads%2F2015%2F02%2Fnew-avatar-sq.jpg&amp;w=750&amp;q=75 2x" src="/_next/image/?url=https%3A%2F%2Fstatic.jamesdigioia.com%2Fuploads%2F2015%2F02%2Fnew-avatar-sq.jpg&amp;w=750&amp;q=75" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"></span></div><div class="font-muli lg:ml-5 grow"><div class="text-4xl lg:text-5xl font-bold font-muli mb-3" data-typeit-id="5108364">James DiGioia<span class="ti-cursor" style="visibility: hidden;"></span></div><div class="text-xl md:text-3xl mb-3 flex flex-row align-center justify-center text-center"><a class="border-2 border-transparent focus:border-primary focus:outline-none" href="https://www.facebook.com/james.digioia" target="_blank" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="text-4xl" style="color:#3b5998" alt="Facebook" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"></path></svg></a><a class="border-2 border-transparent focus:border-primary focus:outline-none" href="https://www.linkedin.com/in/jamesdigioia" target="_blank" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" class="text-4xl" style="color:#4875b4" alt="LinkedIn" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a><a class="border-2 border-transparent focus:border-primary focus:outline-none" href="https://github.com/mAAdhaTTah/" target="_blank" rel="noopener noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" class="text-4xl" style="color:#333" alt="GitHub" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM277.3 415.7c-8.4 1.5-11.5-3.7-11.5-8 0-5.4.2-33 .2-55.3 0-15.6-5.2-25.5-11.3-30.7 37-4.1 76-9.2 76-73.1 0-18.2-6.5-27.3-17.1-39 1.7-4.3 7.4-22-1.7-45-13.9-4.3-45.7 17.9-45.7 17.9-13.2-3.7-27.5-5.6-41.6-5.6-14.1 0-28.4 1.9-41.6 5.6 0 0-31.8-22.2-45.7-17.9-9.1 22.9-3.5 40.6-1.7 45-10.6 11.7-15.6 20.8-15.6 39 0 63.6 37.3 69 74.3 73.1-4.8 4.3-9.1 11.7-10.6 22.3-9.5 4.3-33.8 11.7-48.3-13.9-9.1-15.8-25.5-17.1-25.5-17.1-16.2-.2-1.1 10.2-1.1 10.2 10.8 5 18.4 24.2 18.4 24.2 9.7 29.7 56.1 19.7 56.1 19.7 0 13.9.2 36.5.2 40.6 0 4.3-3 9.5-11.5 8-66-22.1-112.2-84.9-112.2-158.3 0-91.8 70.2-161.5 162-161.5S388 165.6 388 257.4c.1 73.4-44.7 136.3-110.7 158.3zm-98.1-61.1c-1.9.4-3.7-.4-3.9-1.7-.2-1.5 1.1-2.8 3-3.2 1.9-.2 3.7.6 3.9 1.9.3 1.3-1 2.6-3 3zm-9.5-.9c0 1.3-1.5 2.4-3.5 2.4-2.2.2-3.7-.9-3.7-2.4 0-1.3 1.5-2.4 3.5-2.4 1.9-.2 3.7.9 3.7 2.4zm-13.7-1.1c-.4 1.3-2.4 1.9-4.1 1.3-1.9-.4-3.2-1.9-2.8-3.2.4-1.3 2.4-1.9 4.1-1.5 2 .6 3.3 2.1 2.8 3.4zm-12.3-5.4c-.9 1.1-2.8.9-4.3-.6-1.5-1.3-1.9-3.2-.9-4.1.9-1.1 2.8-.9 4.3.6 1.3 1.3 1.8 3.3.9 4.1zm-9.1-9.1c-.9.6-2.6 0-3.7-1.5s-1.1-3.2 0-3.9c1.1-.9 2.8-.2 3.7 1.3 1.1 1.5 1.1 3.3 0 4.1zm-6.5-9.7c-.9.9-2.4.4-3.5-.6-1.1-1.3-1.3-2.8-.4-3.5.9-.9 2.4-.4 3.5.6 1.1 1.3 1.3 2.8.4 3.5zm-6.7-7.4c-.4.9-1.7 1.1-2.8.4-1.3-.6-1.9-1.7-1.5-2.6.4-.6 1.5-.9 2.8-.4 1.3.7 1.9 1.8 1.5 2.6z"></path></svg></a></div><div class="relative text-xl lg:text-3xl" data-typeit-id="0594886">my little web home<span class="ti-cursor" style="visibility: hidden;"></span></div></div></div></div></header><div class="fixed top-2 left-2 z-50"><button class="rounded-full bg-darkg text-secondary p-1 border-2 border-darkg focus:outline-none focus:border-lightg"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" class="text-lg" alt="" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"></path></svg><div style="border:0;clip:rect(0 0 0 0);clip-path:inset(50%);height:1px;margin:0 -1px -1px 0;overflow:hidden;padding:0;position:absolute;width:1px;white-space:nowrap">Open menu</div></button></div></div><div class="relative grow"><div style="opacity:1" class="absolute w-full"><main class="print:pt-0 print:mx-0 print:max-w-full"><div class="max-w-xl mx-auto"><article class="p-5 flow-root rounded pb-3 mb-5 max-w-xl mx-auto bg-primary"><header class="relative mb-5"><img src="https://static.jamesdigioia.com/uploads/2015/08/post-01052013.jpg" alt="" class=""><div class="absolute pin-x-center pin-y-bottom w-full bg-etched rounded p-5"><div class="text-center"><h1 class="text-4xl text-lightg font-muli mb-5">A Better WordPress Singleton</h1></div><div class="flex justify-center"><div class="grow-0 entry-meta my-2 flex items-center rounded bg-secondary p-3 mb-3"><time class="font-body published" datetime="2015-08-06T14:30:40.000Z">August 6th, 2015</time><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="mx-3 w-1" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8z"></path></svg><p class="font-body">James DiGioia</p></div></div></div></header><section class="max-w-prose"><p class="font-ovo text-xl leading-normal pb-3">If you look at any WordPress plugin of significant size, you’ll probably find most of them boot the same way. From <a class="no-underline border-b-2 border-darkg" href="https://github.com/buddypress/BuddyPress/blob/master/src/bp-loader.php#L134-L153">BuddyPress</a>, to <a class="no-underline border-b-2 border-darkg" href="https://github.com/PressForward/pressforward/blob/master/pressforward.php#L54-L62">PressForward</a>, to <a class="no-underline border-b-2 border-darkg" href="https://github.com/Automattic/jetpack/blob/master/class.jetpack.php#L291-L307">JetPack</a>, all of these boot the same way: with singletons. JetPack in particular is interesting, as many of its modules are <a class="no-underline border-b-2 border-darkg" href="https://github.com/Automattic/jetpack/blob/master/modules/markdown/easy-markdown.php#L54-L58">also</a> <a class="no-underline border-b-2 border-darkg" href="https://github.com/Automattic/jetpack/blob/master/class.jetpack-admin.php#L17-L22">singletons</a> <a class="no-underline border-b-2 border-darkg" href="https://github.com/Automattic/jetpack/blob/master/modules/custom-post-types/portfolios.php#L21-L29">themselves</a>. It’s an extremely common pattern in WordPress plugin development, wrapping the main plugin class in a singleton and instantiating it through a static method, which then enforces only a single instance of the class exists and <em>can ever exist</em>. The prototypical example looks like this in PHP:</p><p class="font-ovo text-xl leading-normal pb-3">[gistpen id=4493]</p><p class="font-ovo text-xl leading-normal pb-3">Note the <code class="whitespace-nowrap">protected</code> constructor: This means that the class can only be instantiated by itself (in this case, by the static <code class="whitespace-nowrap">init</code> method), so no other code can create a new instance of the class. That same <code class="whitespace-nowrap">init</code> method saves the . The second time, the instance already exists statically and is returned directly.</p><p class="font-ovo text-xl leading-normal pb-3">Singletons are generally an <a class="no-underline border-b-2 border-darkg" href="http://stackoverflow.com/questions/12755539/why-is-singleton-considered-an-anti-pattern">anti-pattern</a> in wider object-oriented development. The biggest issue is if you ever find yourself needing two instances of the object, you’re screwed; it’ll take a ton of refactoring to undo all the locations in which the singleton static method is called.</p><p class="font-ovo text-xl leading-normal pb-3">Singletons are generally much worse in other languages, like Java, where the application is long-running and there is a shared memory space. The drawbacks often encountered in those languages are not encountered in PHP, with its stateless, single-thread, fire-and-die approach to web development.</p><p class="font-ovo text-xl leading-normal pb-3">Even though I’m a big fan of WordPress generally, it’s full of anti-patterns (<em>omg the globals!</em>), so I’m not really that bothered by the idea of plugin developers adding another one onto the heap, and in this case, it actually solves a lot more problems than it causes because in WordPress, you don’t want multiple instance of your main plugin class floating about. However, the singleton pattern does still have an issue in WordPress:</p><p class="font-ovo text-xl leading-normal pb-3"><em>You’ve completely locked yourself off from your constructor.</em></p><p class="font-ovo text-xl leading-normal pb-3">This generally isn’t a huge issue in WordPress plugins, as most plugins don’t do any kind of unit testing, but if you’re interested in doing unit testing and your main plugin class has any dependencies at all, being unable to access your constructor means you’re unable to mock any of those dependencies, or pass in anything at all.</p><p class="font-ovo text-xl leading-normal pb-3">I’ve spent a little bit of time playing around with Laravel, Pimple, and some of the other dependency injection containers out in the wider PHP world, because I wanted to more effectively unit test my plugins, and in addition to the singleton pattern, many of those main singleton classes also function effectively as containers as well. <a class="no-underline border-b-2 border-darkg" href="https://github.com/PressForward/pressforward/blob/master/pressforward.php#L77-L91">PressForward</a> sets up all its dependencies there and uses them throughout the application, so I wanted to build something that fits with the pattern many WordPress plugin developers are already familiar with. That means the main application container class should be a singleton.</p><p class="font-ovo text-xl leading-normal pb-3">Instead of through static methods, you can enforce the class’s <em>singleton-ness</em> the class’s constructor:</p><p class="font-ovo text-xl leading-normal pb-3">[gistpen id=4503]</p><p class="font-ovo text-xl leading-normal pb-3">Now, if an instance already exists, an Exception is thrown, so another developer would not be able to instantiate a new instance of the main plugin class. The constructor its is now exposed, so any dependencies, even if it’s just the boot file location, can be passed into the main class, and the class’s singleton-ness is still maintained.</p><p class="font-ovo text-xl leading-normal pb-3">Now, you might think you just throw <code class="whitespace-nowrap">$app = new PluginClass(__FILE__);</code> into your main plugin file and you’re good to go, but you’d be wrong. We’re doing all this work to minimize the number of global variables, so that would be a bad idea. You could wrap it in a function so no global variables are leaked, but then you’ve added a global function (less of a problem, but still a problem). So there’s one more trick I’d like to share:</p><p class="font-ovo text-xl leading-normal pb-3">[gistpen id=4509]</p><p class="font-ovo text-xl leading-normal pb-3">This was pulled from a suggestion in a pull request on the <a class="no-underline border-b-2 border-darkg" href="https://github.com/DevinVinson/WordPress-Plugin-Boilerplate/pull/321">WordPress Plugin Boilerplate</a>, so I can’t claim credit for it, but it is a great way of solving the global problem. Now, the class is instantiated, its boot method is run, access to its constructor is preserved, no globals are leaked, and you still enforce it as a singleton.</p><p class="font-ovo text-xl leading-normal pb-3">This singleton design is implemented in the WordPress plugin framework I’m building, <a class="no-underline border-b-2 border-darkg" href="https://github.com/intraxia/jaxion">jaxion</a>, so you can see the current implementation <a class="no-underline border-b-2 border-darkg" href="https://github.com/intraxia/jaxion/blob/master/src/Core/Application.php">here</a>. The boot method will be the default startup for <a class="no-underline border-b-2 border-darkg" href="https://github.com/intraxia/jaxion-bootstrap/blob/master/plugin-name.php#L34-L38">jaxion-boostrap</a>, the plugin boilerplate built on jaxion. You can see the current implementation <a class="no-underline border-b-2 border-darkg" href="https://github.com/intraxia/jaxion-bootstrap/blob/master/plugin-name.php#L34-L38">here</a>.</p><p class="font-ovo text-xl leading-normal pb-3">What do you think? Will you start using this singleton pattern in your WordPress plugins?</p></section></article></div></main></div></div></div></div>